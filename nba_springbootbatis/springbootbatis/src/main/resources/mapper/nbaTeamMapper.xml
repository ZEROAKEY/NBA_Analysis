<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.SpringBootBatis.mapper.NbaMapper">

    <!-- 获取球队信息并按指定字段排序 -->
    <select id="getTeamsSortByIndex" parameterType="map" resultType="TeamBean">
        SELECT ts.*, ti.*
        FROM nba_teams_stats ts
        JOIN team_info ti ON ts.team_id = ti.team_id
        <trim prefix="WHERE" suffixOverrides="AND">
            <!-- 按赛季年份筛选 -->
            <if test="season_year != null">
                ts.season_year = #{season_year} AND
            </if>

            <!-- 按球队名称筛选（中文球队名映射为英文球队名） -->
            <if test="team_name != null and team_name != ''">
                ti.team_name LIKE
                <trim prefix="CASE" suffix="END">
                    <trim prefix="WHEN #{team_name} = '亚特兰大老鹰' THEN "> '%Atlanta Hawks%' </trim>
                    <trim prefix="WHEN #{team_name} = '波士顿凯尔特人' THEN "> '%Boston Celtics%' </trim>
                    <trim prefix="WHEN #{team_name} = '布鲁克林篮网' THEN "> '%Brooklyn Nets%' </trim>
                    <trim prefix="WHEN #{team_name} = '夏洛特黄蜂' THEN "> '%Charlotte Hornets%' </trim>
                    <trim prefix="WHEN #{team_name} = '芝加哥公牛' THEN "> '%Chicago Bulls%' </trim>
                    <trim prefix="WHEN #{team_name} = '克利夫兰骑士' THEN "> '%Cleveland Cavaliers%' </trim>
                    <trim prefix="WHEN #{team_name} = '达拉斯独行侠' THEN "> '%Dallas Mavericks%' </trim>
                    <trim prefix="WHEN #{team_name} = '丹佛掘金' THEN "> '%Denver Nuggets%' </trim>
                    <trim prefix="WHEN #{team_name} = '底特律活塞' THEN "> '%Detroit Pistons%' </trim>
                    <trim prefix="WHEN #{team_name} = '金州勇士' THEN "> '%Golden State Warriors%' </trim>
                    <trim prefix="WHEN #{team_name} = '休斯顿火箭' THEN "> '%Houston Rockets%' </trim>
                    <trim prefix="WHEN #{team_name} = '印第安纳步行者' THEN "> '%Indiana Pacers%' </trim>
                    <trim prefix="WHEN #{team_name} = '洛杉矶快船' THEN "> '%Los Angeles Clippers%' </trim>
                    <trim prefix="WHEN #{team_name} = '洛杉矶湖人' THEN "> '%Los Angeles Lakers%' </trim>
                    <trim prefix="WHEN #{team_name} = '孟菲斯灰熊' THEN "> '%Memphis Grizzlies%' </trim>
                    <trim prefix="WHEN #{team_name} = '迈阿密热火' THEN "> '%Miami Heat%' </trim>
                    <trim prefix="WHEN #{team_name} = '密尔沃基雄鹿' THEN "> '%Milwaukee Bucks%' </trim>
                    <trim prefix="WHEN #{team_name} = '明尼苏达森林狼' THEN "> '%Minnesota Timberwolves%' </trim>
                    <trim prefix="WHEN #{team_name} = '新奥尔良鹈鹕' THEN "> '%New Orleans Pelicans%' </trim>
                    <trim prefix="WHEN #{team_name} = '纽约尼克斯' THEN "> '%New York Knicks%' </trim>
                    <trim prefix="WHEN #{team_name} = '俄克拉荷马城雷霆' THEN "> '%Oklahoma City Thunder%' </trim>
                    <trim prefix="WHEN #{team_name} = '奥兰多魔术' THEN "> '%Orlando Magic%' </trim>
                    <trim prefix="WHEN #{team_name} = '费城76人' THEN "> '%Philadelphia 76ers%' </trim>
                    <trim prefix="WHEN #{team_name} = '菲尼克斯太阳' THEN "> '%Phoenix Suns%' </trim>
                    <trim prefix="WHEN #{team_name} = '波特兰开拓者' THEN "> '%Portland Trail Blazers%' </trim>
                    <trim prefix="WHEN #{team_name} = '萨克拉门托国王' THEN "> '%Sacramento Kings%' </trim>
                    <trim prefix="WHEN #{team_name} = '圣安东尼奥马刺' THEN "> '%San Antonio Spurs%' </trim>
                    <trim prefix="WHEN #{team_name} = '多伦多猛龙' THEN "> '%Toronto Raptors%' </trim>
                    <trim prefix="WHEN #{team_name} = '犹他爵士' THEN "> '%Utah Jazz%' </trim>
                    <trim prefix="WHEN #{team_name} = '华盛顿奇才' THEN "> '%Washington Wizards%' </trim>
                </trim>
            </if>

            <!-- 按球队 ID 筛选 -->
            <if test="team_id != null">
                ts.team_id = #{team_id} AND
            </if>
        </trim>

        <!-- 按指定字段排序 -->
        <if test="index != null and index != ''">
            ORDER BY ${index} DESC
        </if>
    </select>


    <!-- 获取球队排名信息 -->
    <select id="getTeamsRank" parameterType="String" resultType="TeamRankBean">
        SELECT t1.*, t2.*, t3.*
        FROM
            (SELECT ts.team_id,
                    ts.points AS points_per_game, RANK() OVER (ORDER BY ts.points DESC) AS points_per_game_rank,
                    (ts.total_rebounds / ts.games_played) AS rebounds_per_game,
                    RANK() OVER (ORDER BY (ts.total_rebounds / ts.games_played) DESC) AS rebounds_per_game_rank,
                    ts.assists AS assists_per_game, RANK() OVER (ORDER BY ts.assists DESC) AS assists_per_game_rank,
                    ts.steals AS steals_per_game, RANK() OVER (ORDER BY ts.steals DESC) AS steals_per_game_rank,
                    ts.blocks AS blocks_per_game, RANK() OVER (ORDER BY ts.blocks DESC) AS blocks_per_game_rank
             FROM nba_teams_stats ts
             WHERE ts.season_year = #{season_year}) t1,
            (SELECT MAX(ts.points) AS points_per_game_max,
                    MAX(ts.total_rebounds / ts.games_played) AS rebounds_per_game_max,
                    MAX(ts.assists) AS assists_per_game_max,
                    MAX(ts.steals) AS steals_per_game_max,
                    MAX(ts.blocks) AS blocks_per_game_max
             FROM nba_teams_stats ts
             WHERE ts.season_year = #{season_year}) t2,
            (SELECT ROUND(AVG(ts.points), 3) AS points_per_game_avg,
                    ROUND(AVG(ts.total_rebounds / ts.games_played), 3) AS rebounds_per_game_avg,
                    ROUND(AVG(ts.assists), 3) AS assists_per_game_avg,
                    ROUND(AVG(ts.steals), 3) AS steals_per_game_avg,
                    ROUND(AVG(ts.blocks), 3) AS blocks_per_game_avg
             FROM nba_teams_stats ts
             WHERE ts.season_year = #{season_year}) t3
        WHERE t1.team_id = #{team_id};
    </select>

</mapper>
